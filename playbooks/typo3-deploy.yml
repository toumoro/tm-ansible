---
- name: Simple TYPO3 Container Deployment
  hosts: all

  vars:
    server_username: "{{ lookup('env','SERVER_USERNAME') }}"
    project_client: "{{ lookup('env','PROJECT_CLIENT') }}"
    github_repository: "{{ lookup('env','GITHUB_REPOSITORY') }}"
    typo3_container: "{{ lookup('env', 'TM_TYPO3_CONTAINER') | default('php-fpm', true) }}"
    docker_pull_policy: "{{ lookup('env', 'DOCKER_PULL_POLICY') | default('always', true) }}" # options: 'always', 'missing', 'never', 'policy'
    docker_build_policy: "{{ lookup('env', 'DOCKER_BUILD_POLICY') | default('always', true) }}" # options: 'always', 'never', 'policy'
    typo3_user: www-data
    typo3_workdir: /var/www

  tasks:
    # -------------------------------------------------------------------------
    # Step 0: Define fact
    # -------------------------------------------------------------------------
    - name: Set project root path
      ansible.builtin.set_fact:
        project_root: "/home/{{ server_username }}/www/{{ project_client }}"
    - name: Set repo
      ansible.builtin.set_fact:
        repository_client: "git@github.com:{{ github_repository }}"
    # -------------------------------------------------------------------------
    # Step 1: Move to project root
    # -------------------------------------------------------------------------
    - name: Ensure project root exists
      ansible.builtin.file:
        path: "{{ project_root }}"
        #recurse: true
        state: directory

    # -------------------------------------------------------------------------
    # Step 2: Update repository
    # -------------------------------------------------------------------------
    - name: Mark directory as safe for git
      ansible.builtin.command:
        cmd: git config --global --add safe.directory {{ project_root }}
    - name: Mark directory as safe for git
      ansible.builtin.command:
        cmd: git config --global --add safe.directory {{ typo3_workdir }}


    - name: Reset local changes
      ansible.builtin.command:
        cmd: git checkout .
        chdir: "{{ project_root }}"

    - name: Pull latest code
      ansible.builtin.git:
        repo: "{{ repository_client }}"
        dest: "{{ project_root }}"
        update: yes
        force: yes

    # -------------------------------------------------------------------------
    # Step 3: Pull Docker images
    # -------------------------------------------------------------------------
    - name: Pull Docker images
      community.docker.docker_compose_v2:
        project_src: "{{ project_root }}"
        pull: "{{ docker_pull_policy }}"

    # -------------------------------------------------------------------------
    # Step 4: Build containers (no cache)
    # -------------------------------------------------------------------------
    - name: Build Docker containers
      community.docker.docker_compose_v2:
        project_src: "{{ project_root }}"
        build: "{{ docker_build_policy }}"

    # -------------------------------------------------------------------------
    # Step 5: Start containers
    # -------------------------------------------------------------------------
    - name: Start Docker containers
      community.docker.docker_compose_v2:
        project_src: "{{ project_root }}"
        state: present

    # -------------------------------------------------------------------------
    # Step 6: Wait for services
    # -------------------------------------------------------------------------
    - name: Wait for containers to be ready
      ansible.builtin.pause:
        seconds: 10

    # -------------------------------------------------------------------------
    # Step 7: TYPO3 maintenance commands
    # -------------------------------------------------------------------------
    - name: Check if database:updateschema exists
      ansible.builtin.command: >
        docker compose exec -T
        -u www-data
        -w /var/www
        "{{ typo3_container }}"
        ./vendor/bin/typo3 list
      args:
        chdir: "{{ project_root }}"
      register: typo3_commands
      changed_when: false
      failed_when: false

    - name: Composer install
      ansible.builtin.command: >
        docker compose exec -T
        -u www-data
        -w /var/www
        "{{ typo3_container }}" composer install
      args:
        chdir: "{{ project_root }}"
    
    - name: TYPO3 database schema update via bin/typo3
      ansible.builtin.command: >
        docker compose exec -T
        -u www-data
        -w /var/www
        "{{ typo3_container }}" ./vendor/bin/typo3 database:updateschema
      args:
        chdir: "{{ project_root }}"
      when: "'database:updateschema' in typo3_commands.stdout"

    - name: TYPO3 database schema update via bin/typo3cms
      ansible.builtin.command: >
        docker compose exec -T
        -u www-data
        -w /var/www
        "{{ typo3_container }}" ./vendor/bin/typo3cms database:updateschema
      args:
        chdir: "{{ project_root }}"
      when: "'database:updateschema' not in typo3_commands.stdout"
    
    - name: TYPO3 cache flush
      ansible.builtin.command: >
        docker compose exec -T
        -u www-data
        -w /var/www
        "{{ typo3_container }}" ./vendor/bin/typo3 cache:flush
      args:
        chdir: "{{ project_root }}"
    
    # -------------------------------------------------------------------------
    # Step 8: Deployment complete
    # -------------------------------------------------------------------------
    - name: Deployment completed
      ansible.builtin.debug:
        msg: "Simple TYPO3 Container deployment completed successfully"
